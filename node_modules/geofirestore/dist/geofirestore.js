!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).window=t.window||{})}(this,(function(t){"use strict";const e="0123456789bcdefghjkmnpqrstuvwxyz";function r(t,e){const r=e/110574,i=Math.min(90,t.latitude+r),n=Math.max(-90,t.latitude-r),s=2*Math.floor((o=e,Math.min(_(20003930/o),110)));var o;const a=2*Math.floor(f(e,i))-1,c=2*Math.floor(f(e,n))-1;return Math.min(s,a,c,110)}function i(t,e){w(t),w(e);const r=n(e.latitude-t.latitude),i=n(e.longitude-t.longitude),s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(n(t.latitude))*Math.cos(n(e.latitude))*Math.sin(i/2)*Math.sin(i/2);return 6371*(2*Math.atan2(Math.sqrt(s),Math.sqrt(1-s)))}function n(t){if("number"!=typeof t||isNaN(t))throw new Error("Error: degrees must be a number");return t*Math.PI/180}function s(t,r=10){if(w(t),"number"!=typeof r||isNaN(r))throw new Error("precision must be a number");if(r<=0)throw new Error("precision must be greater than 0");if(r>22)throw new Error("precision cannot be greater than 22");if(Math.round(r)!==r)throw new Error("precision must be an integer");const i={min:-90,max:90},n={min:-180,max:180};let s="",o=0,a=0,c=1;for(;s.length<r;){const r=c?t.longitude:t.latitude,u=c?n:i,h=(u.min+u.max)/2;r>h?(o=1+(o<<1),u.min=h):(o=0+(o<<1),u.max=h),c=!c,a<4?a++:(a=0,s+=e[o],o=0)}return s}function o(t,e,r){return w(t),b(e),{g:e,l:t,d:r}}function a(t){const e=Object.assign({},t);return delete e.customKey,e}function c(t,e){if("[object Object]"===Object.prototype.toString.call(t)){const r=e?e.customKey:null,i="d"in t?t.d:t,n=h(i,r,e&&(e.merge||!!e.mergeFields));if(n){return o(n,s(n),i)}return{d:i}}throw new Error("document must be an object")}function u(t,e){if("[object Object]"===Object.prototype.toString.call(t)){const r={},i=h(t,e,!0);return i&&(r.l=i,r.g=s(r.l)),Object.getOwnPropertyNames(t).forEach(e=>{r["d."+e]=t[e]}),r}throw new Error("document must be an object")}function h(t,e,r=!1){let i,n;if(e)if(e in t)n=t[e];else{const r=e.split(".");n=t;for(const e of r){if(!(e in n)){n=t.coordinates;break}n=n[e]}}else n=t.coordinates;if(n||(i="could not find GeoPoint"),n&&!w(n,!0)&&(i="invalid GeoPoint"),i&&!r)throw new Error("Invalid GeoFirestore document: "+i);return n}function d(t,e){const r=function(t,e){if(p(t,!0)){return{data:()=>t.d,distance:e?i(t.l,e):null}}return{data:()=>t,distance:null}}(t.data(),e);return Object.assign({exists:t.exists,id:t.id},r)}function l(t,i){w(t);const n=Math.max(1,r(t,i)),o=Math.ceil(n/5),a=function(t,e){const r=e/110574,i=Math.min(90,t.latitude+r),n=Math.max(-90,t.latitude-r),s=m(e,i),o=m(e,n),a=Math.max(s,o);return[g(t.latitude,t.longitude),g(t.latitude,v(t.longitude-a)),g(t.latitude,v(t.longitude+a)),g(i,t.longitude),g(i,v(t.longitude-a)),g(i,v(t.longitude+a)),g(n,t.longitude),g(n,v(t.longitude-a)),g(n,v(t.longitude+a))]}(t,i).map(t=>function(t,r){b(t);const i=Math.ceil(r/5);if(t.length<i)return[t,t+"~"];const n=t.substring(0,i),s=n.substring(0,n.length-1),o=e.indexOf(n.charAt(n.length-1)),a=r-5*s.length,c=5-a,u=o>>c<<c,h=u+(1<<c);return h>31?[s+e[u],s+"~"]:[s+e[u],s+e[h]]}(s(t,o),n));return a.filter((t,e)=>!a.some((r,i)=>e>i&&t[0]===r[0]&&t[1]===r[1]))}function _(t){return Math.log(t)/Math.log(2)}function f(t,e){const r=m(t,e);return Math.abs(r)>1e-6?Math.max(1,_(360/r)):1}function m(t,e){const r=n(e),i=6378137*Math.cos(r)*Math.PI/180*(1/Math.sqrt(1-.00669447819799*Math.sin(r)*Math.sin(r)));return i<1e-12?t>0?360:0:Math.min(360,t/i)}function g(t,e){const r={latitude:t,longitude:e};return w(r),r}function p(t,e=!1){let r;if(r=b(t.g,!0)?null:"invalid geohash on object",r=w(t.l,!0)?r:"invalid location on object",t&&"d"in t&&"object"==typeof t.d||(r="no valid document found"),r&&!e)throw new Error("Invalid GeoFirestore object: "+r);return!r}function b(t,r=!1){let i;if("string"!=typeof t)i="geohash must be a string";else if(0===t.length)i="geohash cannot be the empty string";else for(const r of t)-1===e.indexOf(r)&&(i="geohash cannot contain '"+r+"'");if(void 0===i||r)return!i;throw new Error("Invalid GeoFire geohash '"+t+"': "+i)}function y(t,e=!1){let r;if("number"!=typeof t||isNaN(t)?r="limit must be a number":t<0&&(r="limit must be greater than or equal to 0"),void 0===r||e)return!r;throw new Error(r)}function w(t,e=!1){let r;if(t)if(void 0===t.latitude)r="latitude must exist on GeoPoint";else if(void 0===t.longitude)r="longitude must exist on GeoPoint";else{const e=t.latitude,i=t.longitude;"number"!=typeof e||isNaN(e)?r="latitude must be a number":e<-90||e>90?r="latitude must be within the range [-90, 90]":"number"!=typeof i||isNaN(i)?r="longitude must be a number":(i<-180||i>180)&&(r="longitude must be within the range [-180, 180]")}else r="GeoPoint must exist";if(void 0===r||e)return!r;throw new Error("Invalid location: "+r)}function q(t,e=!1){if("object"!=typeof t)throw new Error("QueryCriteria must be an object");if(void 0===t.center&&void 0===t.radius)throw new Error("radius and/or center must be specified");if(e&&(void 0===t.center||void 0===t.radius))throw new Error("QueryCriteria for a new query must contain both a center and a radius");const r=Object.keys(t);for(const t of r)if(!["center","radius","limit"].includes(t))throw new Error("Unexpected attribute '"+t+"' found in query criteria");if(void 0!==t.center&&w(t.center),void 0!==t.radius){if("number"!=typeof t.radius||isNaN(t.radius))throw new Error("radius must be a number");if(t.radius<0)throw new Error("radius must be greater than or equal to 0")}void 0!==t.limit&&y(t.limit)}function v(t){if(t<=180&&t>=-180)return t;const e=t+180;return e>0?e%360-180:180- -e%360}class E{constructor(t){if(this._snapshot=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("DocumentSnapshot must be an instance of a Firestore DocumentSnapshot");this._isWeb="[object Function]"===Object.prototype.toString.call(t.ref.firestore.enablePersistence)}get native(){return this._snapshot}get exists(){return this._snapshot.exists}get id(){return this._snapshot.id}get ref(){return new M(this._snapshot.ref)}data(t){const e=this._isWeb&&t?this._snapshot.data(t):this._snapshot.data();return e?p(r=e,!0)?r.d:r:null;var r}get(t,e){const r="d."+t;return this._isWeb&&e?this._snapshot.get(r,e):this._snapshot.get(r)}isEqual(t){return t instanceof E?this._snapshot.isEqual(t._snapshot):this._snapshot.isEqual(t)}}class j{constructor(t){if(this._writeBatch=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("WriteBatch must be an instance of a Firestore WriteBatch")}get native(){return this._writeBatch}set(t,e,r){const i=t instanceof M?t._document:t;return this._writeBatch.set(i,c(e,r),a(r)),this}update(t,e,r){const i=t instanceof M?t._document:t;return this._writeBatch.update(i,u(e,r)),this}delete(t){const e=t instanceof M?t._document:t;return this._writeBatch.delete(e),this}commit(){return this._writeBatch.commit()}}class x{constructor(t){if(this._firestore=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Firestore must be an instance of Firestore")}get native(){return this._firestore}batch(){return new j(this._firestore.batch())}collection(t){return new R(this._firestore.collection(t))}runTransaction(t){return this._firestore.runTransaction(t)}}class M{constructor(t){if(this._document=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("DocumentReference must be an instance of a Firestore DocumentReference");this._isWeb="[object Function]"===Object.prototype.toString.call(t.firestore.enablePersistence)}get native(){return this._document}get id(){return this._document.id}get firestore(){return new x(this._document.firestore)}get onSnapshot(){return(t,e)=>this._document.onSnapshot(e=>t(new E(e)),t=>{e&&e(t)})}get parent(){return new R(this._document.parent)}get path(){return this._document.path}collection(t){return new R(this._document.collection(t))}delete(){return this._document.delete().then(()=>null)}get(t={source:"default"}){return this._isWeb?this._document.get(t).then(t=>new E(t)):this._document.get().then(t=>new E(t))}isEqual(t){return t instanceof M?this._document.isEqual(t._document):this._document.isEqual(t)}set(t,e){return this._document.set(c(t,e),a(e)).then(()=>null)}update(t,e){return this._document.update(u(t,e)).then(()=>null)}}class C{constructor(t,e){this._querySnapshot=t,this._center=e,e&&w(e),this._docs=t.docs.map(t=>d(t,e))}get native(){return this._querySnapshot}get docs(){return this._docs}get size(){return this._docs.length}get empty(){return!this._docs.length}docChanges(){return(Array.isArray(this._querySnapshot.docChanges)?this._querySnapshot.docChanges:this._querySnapshot.docChanges()).map(t=>({doc:d(t.doc,this._center),newIndex:t.newIndex,oldIndex:t.oldIndex,type:t.type}))}forEach(t,e){this.docs.forEach(t,e)}}class S{constructor(t,e){if(this._queryCriteria=e,this._docs=new Map,q(e),t.forEach(t=>{t.docs.forEach(t=>{const e=i(this._queryCriteria.center,t.data().l);this._queryCriteria.radius>=e&&this._docs.set(t.id,t)})}),this._queryCriteria.limit&&this._docs.size>this._queryCriteria.limit){const t=Array.from(this._docs.values()).map(t=>({distance:i(this._queryCriteria.center,t.data().l),id:t.id})).sort((t,e)=>t.distance-e.distance);for(let e=this._queryCriteria.limit;e<t.length;e++)this._docs.delete(t[e].id)}}getGeoQuerySnapshot(){const t=Array.from(this._docs.values());return new C({docs:t,docChanges:()=>t.map((t,e)=>({doc:t,newIndex:e,oldIndex:-1,type:"added"}))},this._queryCriteria.center)}}class O{constructor(t,e,r,i){this._queries=t,this._queryCriteria=e,this._onNext=r,this._onError=i,this._docs=new Map,this._firstRoundResolved=!1,this._firstEmitted=!1,this._newValues=!1,this._subscriptions=[],this._queriesResolved=[],q(e),this._queriesResolved=new Array(t.length).fill(0),t.forEach((t,e)=>{const r=t.onSnapshot(t=>this._processSnapshot(t,e),t=>this._error=t);this._subscriptions.push(r)}),this._interval=setInterval(()=>this._emit(),100)}unsubscribe(){return()=>{clearInterval(this._interval),this._subscriptions.forEach(t=>t())}}_next(){if(this._queryCriteria.limit&&this._docs.size>this._queryCriteria.limit){const t=Array.from(this._docs.values()).sort((t,e)=>t.distance-e.distance);for(let e=this._queryCriteria.limit;e<t.length;e++)if(t[e].emitted){const r={change:Object.assign({},t[e].change),distance:t[e].distance,emitted:t[e].emitted};r.change.type="removed",this._docs.set(r.change.doc.id,r)}else this._docs.delete(t[e].change.doc.id)}let t=0;const e=Array.from(this._docs.values()).map((e,r)=>{const i={type:e.change.type,doc:e.change.doc,oldIndex:e.emitted?e.change.newIndex:-1,newIndex:"removed"!==e.change.type?r-t:-1};return"removed"===i.type?(t--,this._docs.delete(i.doc.id)):this._docs.set(i.doc.id,{change:i,distance:e.distance,emitted:!0}),i}),r=e.reduce((t,e)=>(e.newIndex>=0?t.push(e.doc):this._docs.delete(e.doc.id),t),[]);this._firstEmitted=!0,this._onNext(new C({docs:r,docChanges:()=>e.reduce((t,e)=>(-1!==e.oldIndex&&"added"===e.type||t.push(e),t),[])},this._queryCriteria.center))}_emit(){this._error?(this._onError&&this._onError(this._error),this.unsubscribe()()):this._newValues&&this._firstRoundResolved?(this._newValues=!1,this._next()):this._firstRoundResolved||(this._firstRoundResolved=this._queriesResolved.reduce((t,e)=>t+e,0)===this._queries.length)}_processSnapshot(t,e){const r=Array.isArray(t.docChanges)?t.docChanges:t.docChanges();this._firstRoundResolved||(this._queriesResolved[e]=1),r.length?r.forEach(t=>{const e=t.doc.data().l?i(this._queryCriteria.center,t.doc.data().l):null,r=t.doc.id,n=this._docs.get(r),s={change:{doc:t.doc,oldIndex:n&&this._firstEmitted?n.change.oldIndex:-1,newIndex:n&&this._firstEmitted?n.change.newIndex:-1,type:n&&this._firstEmitted?t.type:"added"},distance:e,emitted:!!this._firstEmitted&&!!n};if(this._queryCriteria.radius>=e){if(!n&&"removed"===s.change.type)return;n||"modified"!==s.change.type||(s.change.type="added"),this._newValues=!0,this._docs.set(r,s)}else n?(s.change.type="removed",this._newValues=!0,this._docs.set(r,s)):n||this._firstRoundResolved||(this._newValues=!0)}):this._firstRoundResolved||(this._newValues=!0)}}class I{constructor(t,e){if(this._query=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Query must be an instance of a Firestore Query");this._isWeb="[object Function]"===Object.prototype.toString.call(t.firestore.enablePersistence),e&&(e.limit&&(this._limit=e.limit),e.center&&e.radius&&(q(e),this._center=e.center,this._radius=e.radius))}get native(){return this._query}get firestore(){return new x(this._query.firestore)}get onSnapshot(){return(t,e)=>{if(this._center&&this._radius)return new O(this._generateQuery(),this._queryCriteria,t,e).unsubscribe();return(this._limit?this._query.limit(this._limit):this._query).onSnapshot(e=>t(new C(e)),e)}}get(t={source:"default"}){if(this._center&&void 0!==this._radius){const e=this._generateQuery().map(e=>this._isWeb?e.get(t):e.get());return Promise.all(e).then(t=>new S(t,this._queryCriteria).getGeoQuerySnapshot())}{const e=this._limit?this._query.limit(this._limit):this._query;return(this._isWeb?e.get(t):e.get()).then(t=>new C(t))}}limit(t){return y(t),this._limit=t,new I(this._query,this._queryCriteria)}near(t){return q(t),this._center=t.center||this._center,this._radius=t.radius||this._radius,new I(this._query,this._queryCriteria)}where(t,e,r){return new I(this._query.where(t?"d."+t:t,e,r),this._queryCriteria)}_generateQuery(){let t=l(this._center,1e3*this._radius).map(this._queryToString);return t=t.filter((e,r)=>t.indexOf(e)===r),t.map(t=>{const e=this._stringToQuery(t);return this._query.orderBy("g").startAt(e[0]).endAt(e[1])})}get _queryCriteria(){return{center:this._center,limit:this._limit,radius:this._radius}}_stringToQuery(t){const e=t.split(":");if(2!==e.length)throw new Error("Invalid internal state! Not a valid geohash query: "+t);return e}_queryToString(t){if(2!==t.length)throw new Error("Not a valid geohash query: "+t);return t[0]+":"+t[1]}}class R extends I{constructor(t){super(t),this._collection=t}get native(){return this._collection}get id(){return this._collection.id}get parent(){return this._collection.parent?new M(this._collection.parent):null}get path(){return this._collection.path}add(t,e){if("[object Object]"===Object.prototype.toString.call(t)){const r=h(t,e),i=s(r);return this._collection.add(o(r,i,t)).then(t=>new M(t))}throw new Error("document must be an object")}doc(t){return new M(t?this._collection.doc(t):this._collection.doc())}}t.GeoCollectionReference=R,t.GeoDocumentReference=M,t.GeoDocumentSnapshot=E,t.GeoFirestore=x,t.GeoQuery=I,t.GeoQuerySnapshot=C,t.GeoTransaction=class{constructor(t){if(this._transaction=t,"[object Object]"!==Object.prototype.toString.call(t))throw new Error("Transaction must be an instance of a Firestore Transaction")}get native(){return this._transaction}delete(t){const e=t instanceof M?t._document:t;return this._transaction.delete(e),this}get(t){const e=t instanceof M?t._document:t;return this._transaction.get(e).then(t=>new E(t))}set(t,e,r){const i=t instanceof M?t._document:t;return this._transaction.set(i,c(e,r),a(r)),this}update(t,e,r){const i=t instanceof M?t._document:t;return this._transaction.update(i,u(e,r)),this}},t.GeoWriteBatch=j,Object.defineProperty(t,"__esModule",{value:!0})}));
